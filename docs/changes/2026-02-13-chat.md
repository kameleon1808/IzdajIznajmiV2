# Chat Change Log - 2026-02-13 (Phase G + fixes through 2026-02-20)

Fokus ovog dokumenta je samo chat/realtime domen (attachments, typing/presence, notification realtime i hotfix-evi).

## 1) Phase G implementacija (attachments + realtime signals + rate limits)

### Backend
- Attachment pipeline:
  - `chat_attachments` tabela (image/document metadata).
  - Privatni storage: `storage/app/private/chat/{conversation_id}`.
  - Autorizovan pristup samo participant-ima preko `/api/v1/chat/attachments/*`.
  - Thumbnail processing za image attachment-e preko queue job-a.
- Slanje poruka:
  - `POST /api/v1/conversations/{conversation}/messages` podrzava multipart (`body` + `attachments[]`).
  - Validacije: max 5 fajlova, max 10MB/fajl, mime allow-list (`jpg/jpeg/png/webp/pdf`).
  - Pravilo "body required when no attachments".
- Signali:
  - Typing endpoint-i (`POST/GET /conversations/{id}/typing`) sa cache TTL.
  - Presence endpoint-i (`POST /presence/ping`, `GET /users/{id}/presence`) sa cache TTL.
- Anti-abuse:
  - `chat_messages` rate limiter (30/min po user/thread).
  - `chat_attachments` rate limiter (10 uploads/10min po user/thread).
  - Ocuvano pravilo "3 seeker poruke dok landlord ne odgovori".

### Frontend
- Chat composer:
  - Upload image/pdf attachment-a sa preview i remove pre-send.
  - Upload progress.
  - Render attachment-a u poruci (image grid, pdf link/chip).
- Typing/presence UI:
  - Typing indikator ispod chat header-a.
  - Online badge u header-u za drugog participant-a.

## 2) Hotfix: chat poruke bez page refresh-a

### Problem
- Poruke na `/chat/{id}` nisu dolazile bez refresh-a.
- U browser konzoli su se javljale `WebSocket connection failed` greske.

### Resenje
- Chat realtime prebacen na polling model u `frontend/src/pages/Chat.vue`.
- Uklonjena zavisnost thread osvezavanja od Echo/WebSocket-a na chat stranici.
- Dodato periodicno osvezavanje poruka (~3s) dok je chat otvoren.
- Odrzano postojece polling ponasanje za typing/presence.

## 3) Hotfix: notification badge tek nakon refresh-a

### Problem
- Bell badge i dropdown nisu osvezavali stanje dok se stranica ne refresuje.

### Resenje
- `frontend/src/components/notifications/NotificationBell.vue`:
  - Polling unread count na ~15s.
  - Refresh pri `focus` i `visibilitychange`.
  - Fresh fetch liste pri otvaranju dropdown-a.
- `frontend/src/stores/notifications.ts`:
  - `unreadCount` vise se ne prepisuje iz parcijalne liste notifikacija (page payload).

## 4) Hotfix: duplirane notifikacije (2x za jednu poruku)

### Problem
- Jedna poruka je kreirala dve `message.received` notifikacije.

### Root cause
- Event listener je bio registrovan duplo zbog kombinacije:
  - eksplicitnog `$listen` mapiranja i
  - auto event discovery-ja.

### Resenje
- Event discovery je eksplicitno iskljucen:
  - `backend/bootstrap/app.php`: `withEvents(discover: false)`
  - `backend/app/Providers/EventServiceProvider.php`: `shouldDiscoverEvents(): false`
- Dodat regresioni test:
  - `test_single_message_creates_single_message_notification`
  - `backend/tests/Feature/NotificationsApiTest.php`

## 5) Operativne napomene za deploy/support
- Posle promena event wiring-a obavezno:
  - `php artisan event:clear`
  - `php artisan optimize:clear`
- Za diagnostiku duplih notifikacija:
  - `php artisan event:list` i proveriti da `MessageCreated` nema dupli listener zapis.
- Referentni runbook: `docs/ops/CHAT-REALTIME-SUPPORT.md`.
